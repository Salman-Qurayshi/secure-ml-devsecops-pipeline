pipeline {
  agent any

  environment {
    IMAGE_NAME = "ml-flask-app"
    COMMIT_SHA = sh(script: "git rev-parse --short HEAD", returnStdout: true).trim()
    IMAGE_TAG  = "${IMAGE_NAME}:${COMMIT_SHA}"
    PYTHON     = "${WORKSPACE}/.ci-venv/bin/python"
    PIP        = "${WORKSPACE}/.ci-venv/bin/pip"
  }

  options {
    timestamps()
    ansiColor('xterm')
    buildDiscarder(logRotator(numToKeepStr: '20'))
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Set up Python tools') {
      steps {
        sh '''
          python3 -m venv .ci-venv
          . .ci-venv/bin/activate
          ${PIP} install --upgrade pip
          ${PIP} install -r requirements.txt || true   # app deps (ignore errors if container will handle them)
          ${PIP} install black flake8 bandit pip-audit
        '''
      }
    }

    stage('Lint & SAST') {
      steps {
        sh '''
          . .ci-venv/bin/activate
          ${PYTHON} -m black --check . || true
          ${PYTHON} -m flake8 . --exit-zero
          bandit -c security/bandit-config.yaml -r . --exit-zero
        '''
      }
    }

    stage('Dependency Scan (pip-audit)') {
      steps {
        sh '''
          . .ci-venv/bin/activate
          pip-audit -r requirements.txt -f json -o ci-cd/pip-audit.json --exit-code 0

        '''
      }
      post {
        always {
          archiveArtifacts artifacts: 'ci-cd/pip-audit.json', onlyIfSuccessful: false
        }
      }
    }

    stage('Secrets Scan (gitleaks)') {
      steps {
        sh '''
          mkdir -p ci-cd
          gitleaks detect \
            --config security/.gitleaks.toml \
            --report-path ci-cd/gitleaks.json \
            --report-format json \
            --verbose \
            --no-exit-code
        '''
      }
      post {
        always {
          archiveArtifacts artifacts: 'ci-cd/gitleaks.json', onlyIfSuccessful: false
        }
      }
    }

    stage('Build Docker Image') {
      steps {
        sh '''
          docker build -t ${IMAGE_TAG} .
          docker image ls | head -n 5
        '''
      }
    }

    stage('Container Scan (Trivy)') {
      steps {
        sh '''
          security/trivy-scan.sh ${IMAGE_TAG} || true
        '''
      }
      post {
        always {
          archiveArtifacts artifacts: 'ci-cd/trivy-report.*', onlyIfSuccessful: false
        }
      }
    }

    stage('SBOM (Syft)') {
      steps {
        sh '''
          security/syft-sbom.sh ${IMAGE_TAG} || true
        '''
      }
      post {
        always {
          archiveArtifacts artifacts: 'ci-cd/sbom.json', onlyIfSuccessful: false
        }
      }
    }

    stage('(Optional) Docker Bench - Advisory') {
      when { expression { return false } } // flip to true when you want it
      steps {
        sh 'security/docker-bench.sh || true'
      }
      post {
        always {
          archiveArtifacts artifacts: 'ci-cd/docker-bench.txt', onlyIfSuccessful: false
        }
      }
    }

    stage('Deploy to Staging (VPS)') {
      when {
        anyOf {
          branch 'main'
          branch 'master'
        }
      }
      steps {
        sh '''
          docker compose pull || true
          docker compose down || true
          docker compose up -d || true
          docker ps
        '''
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: 'ci-cd/*.json, ci-cd/*.txt', onlyIfSuccessful: false
    }
  }
}
